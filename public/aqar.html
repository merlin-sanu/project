<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AQAR Reports - ERP-IQAC</title>
  <style>
    :root{
      --accent-blush: #eaaeb3;
      --accent-mauve: #a97d86;
      --bg-1: #FFF7F8;
      --text: #3b2b2e;
      --muted: #8b6f73;
      --panel: linear-gradient(180deg, rgba(255,255,255,0.98), #fff);
      --shadow: rgba(60,40,45,0.08);
      --max-width: 1100px;
    }

    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:var(--text); background: linear-gradient(180deg,var(--bg-1),#fff);}
    .app { display:flex; min-height:100vh; gap:28px; padding:28px; box-sizing:border-box; }

    /* SIDEBAR (modified to use .card appearance to match older look) */
    .sidebar{
      width:220px;
      padding:18px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.65), #fff);
      border-radius:14px;
      box-shadow: 0 12px 36px var(--shadow);
      border:1px solid rgba(150,120,128,0.04);
      flex-shrink:0;
      position:sticky;
      top:28px;
      height: calc(100vh - 56px);
    }
    .brand{
      font-weight:800;
      color:var(--accent-mauve);
      letter-spacing:0.6px;
      font-size:18px;
      padding-left:6px;
    }
    nav { display:flex; flex-direction:column; gap:10px; margin-top:6px; }
    .nav-item{
      display:block;
      color:#4b3940;
      text-decoration:none;
      padding:10px 12px;
      border-radius:10px;
      font-weight:600;
      transition: all 160ms ease;
      font-size:15px;
    }
    .nav-item.active{
      background: linear-gradient(90deg, var(--accent-blush), var(--accent-mauve));
      color:#fff;
      box-shadow: 0 10px 28px rgba(151,120,131,0.12);
    }
    .nav-item:hover{ background: rgba(151,120,131,0.04); color:var(--accent-mauve); }

    /* main area */
    .main { flex:1; padding: 36px; box-sizing: border-box; }
    .content-wrap { max-width: var(--max-width); margin:0 auto; }

    .page-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .page-header h1 { margin:0; font-size:28px; color:var(--accent-mauve); }
    .btn-create {
      padding:8px 12px;
      border-radius:10px;
      background: linear-gradient(90deg, var(--accent-blush), var(--accent-mauve));
      color:#fff;
      font-weight:800;
      border:none;
      cursor:pointer;
      box-shadow:0 8px 22px rgba(151,120,131,0.12);
    }

    .card {
      background:var(--panel);
      border-radius:12px;
      padding:14px;
      box-shadow: 0 12px 36px var(--shadow);
      border:1px solid rgba(150,120,128,0.04);
    }

    .reports-table { width:100%; border-collapse:collapse; }
    .reports-table thead th { text-align:left; padding:14px 12px; font-weight:700; color:#6b5257; font-size:13px; border-bottom:1px solid rgba(0,0,0,0.04); }
    .reports-table tbody td { padding:14px 12px; vertical-align:middle; color:#5b4649; border-bottom:1px solid rgba(0,0,0,0.04); }

    .file-icon { width:28px;height:28px;border-radius:6px;background:rgba(151,120,131,0.06); display:inline-flex;align-items:center;justify-content:center;font-size:16px;color:var(--accent-mauve); }
    .meta-small { font-size:13px;color:var(--muted); margin-top:4px; }

    .status-badge { display:inline-block; padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px; }
    .status-completed { background:rgba(73,167,124,0.12); color:#2a8a57; }
    .status-inprogress { background:rgba(240,173,78,0.09); color:#b07e1c; }
    .status-pending { background:rgba(151,120,131,0.08); color:var(--accent-mauve); }

    .actions { display:flex; gap:10px; align-items:center; }
    .icon-btn { background:transparent;border:none;cursor:pointer;padding:6px;border-radius:8px;color:var(--accent-mauve); display:inline-flex;align-items:center;justify-content:center; }
    .icon-btn:hover { background: rgba(151,120,131,0.06); }

    /* Modal styles */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.35); display:flex; align-items:center; justify-content:center; z-index:1200; }
    .modal { background:var(--panel); padding:18px; border-radius:12px; width:100%; max-width:560px; box-shadow:0 30px 90px rgba(60,40,45,0.18); }
    .form-row{ margin-bottom:12px; display:flex; flex-direction:column; gap:8px; }
    .input-file { display:flex; gap:10px; align-items:center; }
    .file-choose-btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#fff; border-radius:10px; border:1px solid rgba(0,0,0,0.06); cursor:pointer; font-weight:700; color:var(--accent-mauve); }
    .file-name { font-size:13px; color:var(--muted); min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:320px; }
    .input-file input[type="file"]{ position:absolute!important; left:-9999px; width:1px;height:1px;overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

    .modal input[type="text"], .modal textarea { padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.12); font-size:14px; outline:none; width:100%; box-sizing:border-box; background:#fff; }
    .modal input[type="text"]:focus { border-color: var(--accent-blush); box-shadow: 0 0 6px rgba(234,175,180,0.35); }

    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:8px; }
    .btn-ghost{ padding:8px 12px;border-radius:10px;border:1px solid rgba(151,120,131,0.08); background:transparent; color:var(--accent-mauve); cursor:pointer; }
    .btn-primary { padding:8px 12px;border-radius:10px;background: linear-gradient(90deg, var(--accent-blush), var(--accent-mauve)); color:#fff; border:none; cursor:pointer; }

    @media (max-width:860px){
      .sidebar{ display:none; }
      .main{ padding:18px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- === ASIDE: replaced with older 'card-like' sidebar appearance === -->
    <aside class="sidebar">
      <div class="brand">ERP-IQAC</div>
      <nav>
        <a href="index.html" class="nav-item">Dashboard</a>
        <a href="aqar.html" class="nav-item active">AQAR Reports</a>
        <a href="faculty.html" class="nav-item">Faculty</a>
        <a href="accreditations.html" class="nav-item">Accreditations</a>
        <a href="feedback.html" class="nav-item">Feedback</a>
        <a href="settings.html" class="nav-item">Settings</a>
        <a href="/logout" class="nav-item">Logout</a>
      </nav>
    </aside>

    <main class="main">
      <div class="content-wrap">
        <div class="page-header">
          <h1>AQAR Reports</h1>
          <div>
            <!-- create button hidden for unauthorized by role script (data-requires-role) -->
            <button id="createBtn" data-requires-role class="btn-create">Create New Report</button>
          </div>
        </div>

        <div class="card">
          <table class="reports-table" aria-describedby="reports">
            <thead>
              <tr>
                <th style="width:48%;">REPORT</th>
                <th style="width:22%;">DATE</th>
                <th style="width:14%;">STATUS</th>
                <th style="width:16%;">ACTIONS</th>
              </tr>
            </thead>
            <tbody id="reportsBody">
              <tr><td colspan="4" class="meta-small">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- modal root -->
  <div id="modal-root" style="display:none;"></div>

  <script>
    function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }

    // highlight active nav
    (function highlightActive(){
      const path=(window.location.pathname||'').split('/').pop()||'index.html';
      document.querySelectorAll('.sidebar .nav-item').forEach(link=>{
        const href=(link.getAttribute('href')||'').split('/').pop();
        if(href===path || (path === 'aqar' && href === 'aqar.html')) link.classList.add('active');
        else link.classList.remove('active');
      });
    })();

    const reportsBody = document.getElementById('reportsBody');
    const modalRoot = document.getElementById('modal-root');

    async function loadReports(){
      reportsBody.innerHTML = '<tr><td colspan="4" class="meta-small">Loading‚Ä¶</td></tr>';
      try{
        const res = await fetch('/api/aqar', { credentials: 'include' });
        if(res.status === 401){
          reportsBody.innerHTML = '<tr><td colspan="4" class="meta-small">Not authenticated. Please log in.</td></tr>';
          return;
        }
        if(!res.ok){
          reportsBody.innerHTML = `<tr><td colspan="4" class="meta-small">Failed to load reports: ${res.status}</td></tr>`;
          return;
        }
        const rows = await res.json();
        if(!rows || rows.length === 0){
          reportsBody.innerHTML = '<tr><td colspan="4" class="meta-small">No reports yet. Use "Create New Report" to upload.</td></tr>';
          return;
        }

        reportsBody.innerHTML = '';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const fileUrl = r.filename ? (`/uploads/${r.filename}`) : (r.fileUrl || '#');
          const title = escapeHtml(r.original_name || r.filename || `Report ${r.id}`);
          const date = r.created_at ? (new Date(r.created_at)).toLocaleDateString() : '';
          tr.innerHTML = `
            <td>
              <div style="display:flex;align-items:center;gap:10px;">
                <div class="file-icon" aria-hidden="true">üìÑ</div>
                <div>
                  <div style="font-weight:700">${title}</div>
                  <div class="meta-small">Uploaded by: ${escapeHtml(r.uploader_id || '‚Äî')}</div>
                </div>
              </div>
            </td>
            <td>
              <div style="display:flex;flex-direction:column">
                <div style="font-weight:600">${escapeHtml(date)}</div>
                <div class="meta-small"> ${escapeHtml(r.created_at || '')} </div>
              </div>
            </td>
            <td>${statusEl(r.status || r.state || '')}</td>
            <td>
              <div class="actions">
                <button class="icon-btn view-btn" data-url="${escapeHtml(fileUrl)}" title="View">üëÅÔ∏è</button>
                <a class="icon-btn" href="${escapeHtml(fileUrl)}" download="${escapeHtml(r.original_name || '')}" title="Download">‚¨áÔ∏è</a>
                <!-- delete kept as .del-btn (script will hide for students/parents) -->
                <button class="icon-btn del-btn" data-id="${escapeHtml(r.id)}" title="Delete">üóëÔ∏è</button>
              </div>
            </td>
          `;
          reportsBody.appendChild(tr);
        });
      }catch(err){
        console.error('Load reports error', err);
        reportsBody.innerHTML = '<tr><td colspan="4" class="meta-small">Network error while loading reports.</td></tr>';
      }
    }

    function statusEl(status){
      if(!status) return '<span class="status-badge status-pending">Unknown</span>';
      const s = String(status).toLowerCase();
      if(s.includes('completed') || s.includes('complete')) return '<span class="status-badge status-completed">Completed</span>';
      if(s.includes('progress') || s.includes('in progress')) return '<span class="status-badge status-inprogress">In Progress</span>';
      if(s.includes('pending')) return '<span class="status-badge status-pending">Pending</span>';
      return `<span class="status-badge status-pending">${escapeHtml(status)}</span>`;
    }

    // modal helpers, upload form, actions (kept same as your previous code)
    function openModal(html){
      modalRoot.innerHTML = `<div class="modal-backdrop" id="mb"><div class="modal">${html}</div></div>`;
      modalRoot.style.display = 'block';
      document.getElementById('mb').addEventListener('click', (ev) => { if(ev.target.id === 'mb') closeModal(); });
    }
    function closeModal(){ modalRoot.innerHTML = ''; modalRoot.style.display = 'none'; }

    function showUpload(){
      const html = `
        <h3>Upload AQAR Report</h3>
        <div class="form-row">
          <label class="small-muted">Choose file (PDF/DOC/DOCX). Max 5 MB</label>
          <div class="input-file" id="inputFileWrap">
            <label class="file-choose-btn" for="reportFileInput">Choose File</label>
            <span class="file-name" id="fileName">No file chosen</span>
            <input id="reportFileInput" name="report" type="file" accept=".pdf,.doc,.docx">
          </div>
        </div>

        <div class="form-row">
          <label class="small-muted">Optional: Title</label>
          <input id="reportTitle" type="text" placeholder="Report title (optional)">
        </div>

        <div class="modal-actions">
          <button id="modalCancel" class="btn-ghost" type="button">Cancel</button>
          <button id="modalUpload" class="btn-primary" type="button">Upload</button>
        </div>
      `;
      openModal(html);

      const fileInput = document.getElementById('reportFileInput');
      const nameSpan = document.getElementById('fileName');
      fileInput.addEventListener('change', () => {
        if(fileInput.files && fileInput.files.length){
          const f = fileInput.files[0];
          nameSpan.textContent = `${f.name}`;
        } else {
          nameSpan.textContent = 'No file chosen';
        }
      });

      document.getElementById('modalCancel').addEventListener('click', closeModal);
      document.getElementById('modalUpload').addEventListener('click', async () => {
        if(!fileInput || !fileInput.files || fileInput.files.length === 0){
          alert('Please choose a file to upload.');
          return;
        }
        const f = fileInput.files[0];
        const allowed = ['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        if(!allowed.includes(f.type) && !f.name.match(/\.(pdf|docx?|PDF|DOCX?)$/)){
          alert('Invalid file type. Only PDF / DOC / DOCX allowed.');
          return;
        }
        if(f.size > (5 * 1024 * 1024)){
          alert('File too large. Max 5 MB.');
          return;
        }

        const form = new FormData();
        form.append('report', f);
        form.append('title', document.getElementById('reportTitle').value || '');

        try{
          const resp = await fetch('/api/aqar', { method:'POST', credentials:'include', body: form });
          const json = await resp.json().catch(()=>null);
          if(resp.status === 401){
            alert('Not authenticated. Please login.');
            closeModal();
            window.location = '/login.html';
            return;
          }
          if(!resp.ok){
            console.error('Upload failed', json);
            alert((json && json.error) ? json.error : 'Upload failed');
            return;
          }
          closeModal();
          await loadReports();
        }catch(e){
          console.error('Network upload error', e);
          alert('Network error during upload');
        }
      });
    }

    document.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('.view-btn');
      if(btn){
        const url = btn.dataset.url;
        if(url && url !== '#') window.open(url, '_blank');
        return;
      }
      const del = ev.target.closest('.del-btn');
      if(del){
        const id = del.dataset.id;
        if(!confirm('Delete this report?')) return;
        try{
          const res = await fetch(`/api/aqar/${id}`, { method:'DELETE', credentials:'include' });
          if(res.status === 401){ alert('Not authenticated'); window.location='/login.html'; return; }
          if(!res.ok){
            const j = await res.json().catch(()=>null);
            alert((j && j.error) ? j.error : 'Delete failed');
            return;
          }
          await loadReports();
        }catch(err){
          console.error('Delete error', err);
          alert('Network error');
        }
      }
    });

    document.getElementById('createBtn').addEventListener('click', showUpload);

    loadReports();
  </script>

  <!-- robust role gating script: shows restricted UI only for faculty/admin -->
  <script>
  (async function roleGate(){
    const restrictedSelector = '[data-requires-role]';
    const perCardSelectors = '.edit-btn, .del-btn';

    function hideElements(){
      document.querySelectorAll(restrictedSelector).forEach(el => el.style.display = 'none');
      document.querySelectorAll(perCardSelectors).forEach(el => el.style.display = 'none');
    }
    function showElements(){
      document.querySelectorAll(restrictedSelector).forEach(el => el.style.display = '');
      document.querySelectorAll(perCardSelectors).forEach(el => el.style.display = '');
    }

    // safe default: hide restricted UI immediately
    hideElements();

    let role = null;
    try {
      const res = await fetch('/api/me', { credentials: 'include' });
      if (!res.ok) {
        console.info('roleGate: /api/me returned', res.status);
      } else {
        const j = await res.json();
        if (j && j.user && j.user.role) role = String(j.user.role).toLowerCase();
        else console.info('roleGate: /api/me returned no user or role', j);
      }
    } catch (e) {
      console.warn('roleGate: network error calling /api/me', e);
    }

    const allowed = ['faculty','admin'];
    if (role && allowed.includes(role)) {
      showElements();
      console.info('roleGate: showing restricted UI for role =', role);
    } else {
      hideElements();
      console.info('roleGate: hiding restricted UI for role =', role || '(none)');
    }

    // observe DOM for new nodes and reapply
    const observer = new MutationObserver(muts => {
      let added = false;
      for (const m of muts) {
        if (m.addedNodes && m.addedNodes.length) { added = true; break; }
      }
      if (!added) return;
      if (role && allowed.includes(role)) showElements(); else hideElements();
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // expose small helper
    window.__roleGate = {
      getRole: () => role,
      refresh: async () => {
        try {
          const r = await fetch('/api/me', { credentials:'include' });
          const j = r.ok ? await r.json() : null;
          role = j && j.user && j.user.role ? String(j.user.role).toLowerCase() : null;
          if (role && allowed.includes(role)) showElements(); else hideElements();
          console.info('roleGate.refresh -> role=', role);
        } catch(e){
          console.error('roleGate.refresh error', e);
        }
      }
    };
  })();
  </script>
</body>
</html>
